# 海关数据申报系统

请协助我构建一个基于前后端分离架构的海关数据在线申报系统。该系统主要用于企业用户在线完成海关相关数据的填报与提交。前端使用Vue 3（Composition API）和Element Plus UI框架，后端使用.NET 8+ Web API。数据库需要支持SQL Server和ORACLE。请确保代码结构清晰、规范，并包含必要的注释。
# 重要概念
- 账册：账册是海关对企业进出口货物管理的一本底账数据，需要企业提前向海关申请，海关审批通过后才可以制单。账册分为账册表头和表体，表体的项号（G_NO）为商品备案的序号，申报时需要填写并且根据这个序号带出商品备案信息。
- 核放单：核放单主要是申报车辆信息以及车辆上所拉货物信息。
- 申请单：具体的申报货物表单。

## 功能设计

### 1. 用户管理系统
- 用户注册、登录、权限管理
- 角色分配：管理员、申报员、审核员，初始化默认管理员账号密码
- 用户信息维护（密码修改、个人信息等）
- 登录日志记录
- 必填栏位：用户名、密码、角色、状态、企业海关10位编码，企业名称

### 2. 车辆管理系统
基于 `BASE_VEHICLE` 表结构，包含以下功能：
- 车辆信息录入与维护
  - 基本信息：车牌号、车辆类型、品牌型号
  - 证件信息：IC卡号、电子车牌、许可证号
  - 技术参数：车辆重量、载重量、载客量、颜色
  - 管理信息：经营企业、挂靠单位、申请人
  - 状态管理：备案状态、有效期管理
- 车辆查询与统计

### 3. 申报数据管理系统

#### 3.1 核放单管理（基于 HF_HEAD_PRE 表）
- 已有模块，不需要做功能开发。数据来源于单一申报界面，数据自动写入核放单表

#### 3.2 账册管理（基于 EMS_HEAD_PRE 表）
- 已有模块，不需要做功能开发，只需要使用里面的数据

#### 3.3 商品明细管理（基于EMS_AIMG_PRE和EMS_AEXG_PRE）
- 已有模块，不需要做功能开发，只需要使用里面的数据
#### 3.4 单一申报界面
- 新做功能，支持用户快速录入。 包含列表页面、录入页面：
- 列表页面：包含查询、分页、排序、筛选、导出。栏位包含：序号，核放单号、车辆号码、货物名称、进出标志、核放单状态、申报日期。
- 录入页面：包含核放单表头、商品表体上下两部分。功能包括：保存、申报、复制上一票、保存为模版、加载模版等功能。
-- 核放单表头：包含核放单编号（系统调用存储过程SP_GET_JOB_NO自动产生）、车牌号码、车重、起始地（下拉框）、目的地（下拉框）、区域标志（下拉框）、总重量、备注、包装件数、毛重、包装种类（下拉框）、进出标志（下拉框）、料件性质（下拉框）、账册号。
-- 商品表体：在线表格方式呈现，可以直接编辑行，可添加、删除行。栏位包含：项号、商品名称、申报数量、商品编码、商品规格、计量单位（下拉框）、商品单价、商品总价、申报币值、料件性质、备注。

### 4. 系统辅助功能
- 数据导入导出（Excel格式）
- 报表统计与查询
- 数据模板管理
- 系统日志管理

## 技术要求

### 1. 架构设计
- **前端框架**: Vue 3 + Vite + Pinia (状态管理) + Vue Router + Element Plus + Axios
- **后端框架**: .NET 8+ Web API + JWT认证+ 新建独立的数据库操作类，不依赖任何框架
- **数据库**: SQL Server或Oracle，默认SqlServer，可切换为Oracle
- **架构模式**: MVC 或 三层架构

### 2. 开发规范
- **编码规范**: 代码风格要一致，遵循各自语言的最佳实践。关键逻辑处请添加注释。
- **API设计**: RESTful API，统一响应格式。前后端交互的数据格式统一使用JSON。考虑必要的输入验证和错误处理。
- **错误处理**: 统一异常处理机制
- **日志记录**: 结构化日志，包含操作日志和错误日志

### 3. 数据库要求
- 基于现有SQL Server数据表结构
- 主要表结构：
  - `BASE_VEHICLE`: 车辆基础信息表
  - `HF_HEAD_PRE`: 核放单表头
  - `EMS_HEAD`: 账册表头表
  - `EMS_AIMG_PRE`: 账册进口商品明细
  - `EMS_AEXG_PRE`: 账册出口商品明细
  - `HF_BODY_PRE`: 核放单关联货物表
  - `HF_GJGOODS_PRE`: 核放单关联货物明细表
- 支持事务处理

### 4. 功能要求
- **表单验证**: 前端+后端双重验证
- **权限控制**: 基于角色的权限管理（RBAC）
- **数据缓存**: 常用数据缓存提升性能
- **文件处理**: 支持Excel导入导出
- **实时计算**: 货物总价自动计算

### 5. 界面要求
- **响应式设计**: 兼容PC端，界面友好
- **操作便捷**: 支持键盘快捷操作（Tab导航等）
- **数据展示**: 表格分页、排序、筛选
- **错误提示**: 实时验证提示，错误信息清晰

### 6. 性能要求
- 页面响应时间 < 2秒
- 支持并发用户数 > 100
- 数据库查询优化
- 前端资源压缩与缓存

### 7. 安全要求
- 用户身份认证（JWT Token）
- 密码加密存储
- SQL注入防护
- XSS攻击防护
- 操作日志记录

### 8. 部署要求
- **开发环境**: 支持热重载开发模式
- **生产环境**: Docker容器化部署
- **数据备份**: 定期数据库备份策略
- **监控告警**: 系统运行状态监控

## 开发阶段计划

### 第一阶段：基础框架搭建
- 项目结构初始化
- 数据库连接配置
- 用户认证系统
- 基础UI框架搭建

### 第二阶段：核心功能开发
- 用户管理模块
- 车辆管理模块
- 基础数据维护

### 第三阶段：申报功能开发
- 报关申报管理

### 第四阶段：系统完善
- 数据导入导出
- 报表统计
- 系统优化
- 测试与部署

## 常用命令

### 开发环境
```bash
# 安装依赖
npm install

# 启动开发服务器
npm run dev

# 构建生产版本
npm run build

# 代码检查
npm run lint

# 运行测试
npm run test
```

### 数据库操作
```bash
# 连接SQL Server
sqlcmd -S server_name -d database_name -U username -P password

# 执行SQL脚本
sqlcmd -S server_name -d database_name -i script.sql
```

## 注意事项
- 严格按照现有数据表结构进行开发
- 保证数据一致性和完整性
- 注重用户体验和操作便捷性
- 充分考虑海关申报业务的特殊性和复杂性

## 前后端连接问题排查指南

### 🔧 常见问题和解决方案

#### 1. API路由问题
**问题症状**: 前端请求返回404错误，控制台显示"Request reached the end of the middleware pipeline without being handled"

**检查清单**:
- ✅ **后端Controller路由**: 确认`[HttpGet("route/{param}")]`路由定义正确
- ✅ **前端API路径**: 确认前端请求路径与后端路由完全匹配
- ✅ **HTTP方法**: 确认前端请求方法（GET/POST/PUT/DELETE）与后端注解一致
- ✅ **参数占位符**: 确认路由参数名`{bookNo}`与方法参数名一致

**解决方法**:
```csharp
// 后端Controller示例
[HttpGet("book-item/{bookNo}/{itemNo}")]
public async Task<ActionResult> GetBookItemInfo(string bookNo, string itemNo)
```
```javascript
// 前端API调用示例
getBookItemInfo(bookNo, itemNo) {
    return request.get(`/SystemParameter/book-item/${bookNo}/${itemNo}`)
}
```

#### 2. 后端编译和重启问题
**问题症状**: 代码修改后API行为没有变化，或者出现新的404错误

**解决步骤**:
1. **停止后端服务**: 使用`Ctrl+C`或KillBash工具
2. **清理编译**: `dotnet clean`（可选）
3. **重新编译**: `dotnet build`（可选，dotnet run会自动编译）
4. **重新启动**: `dotnet run`
5. **等待启动完成**: 看到"Application started"日志后再测试

#### 3. 参数传递问题
**问题症状**: 后端接收到空值或格式错误的参数

**检查清单**:
- ✅ **参数名大小写**: C#使用PascalCase，JavaScript使用camelCase
- ✅ **参数类型**: 确认前后端参数类型匹配（string/int/bool等）
- ✅ **URL编码**: 特殊字符需要URL编码
- ✅ **路径参数**: 确认所有路径参数都已传递

**示例**:
```csharp
// 后端方法参数
public async Task<ActionResult> GetData(string bookNo, int itemNo)
```
```javascript
// 前端调用 - 确保参数顺序和类型正确
const response = await api.getData('F04092308019', 1)
```

#### 4. JSON响应格式问题
**问题症状**: 前端解析响应数据失败，或者数据结构不匹配

**检查清单**:
- ✅ **统一响应格式**: 使用`ApiResponse<T>`包装所有响应
- ✅ **字段命名**: 确认前后端字段名一致
- ✅ **数据类型**: 确认日期、数字等类型格式一致
- ✅ **错误处理**: 确认错误响应也使用统一格式

**标准响应格式**:
```csharp
// 后端响应
return Ok(ApiResponse<object>.Ok(data, "操作成功"));
return Ok(ApiResponse<object>.Fail("错误信息"));
```
```javascript
// 前端处理
if (response.success) {
    // 使用 response.data
} else {
    // 显示 response.message
}
```

#### 5. CORS跨域问题
**问题症状**: 浏览器控制台显示CORS错误

**解决方法**:
- 确认后端已配置CORS策略
- 检查前端请求的Origin是否在允许列表中
- 确认预检请求（OPTIONS）正常返回

#### 6. JWT认证问题
**问题症状**: API返回401未授权错误，或Token过期

**解决步骤**:
1. **检查Token有效期**: JWT Token默认3分钟过期
2. **重新登录**: 获取新的Token
3. **确认API授权**: 检查接口是否需要`[AllowAnonymous]`
4. **Header格式**: 确认Authorization头格式正确

#### 7. 数据库连接问题
**问题症状**: API返回500内部错误，后端日志显示数据库连接失败

**检查清单**:
- ✅ **连接字符串**: 确认数据库连接配置正确
- ✅ **数据库服务**: 确认SQL Server服务正在运行
- ✅ **权限**: 确认数据库用户有相应权限
- ✅ **表结构**: 确认查询的表和字段存在

### 🚀 最佳实践

#### 开发流程
1. **后端优先**: 先完成后端API开发和测试
2. **API测试**: 使用curl或Postman测试API接口
3. **前端集成**: 确认后端正常后再开发前端
4. **增量测试**: 每完成一个功能立即测试

#### 调试技巧
1. **查看后端日志**: 使用BashOutput查看详细日志
2. **浏览器调试**: 使用F12查看网络请求和响应
3. **断点调试**: 在关键位置添加断点或日志
4. **分步验证**: 先测试简单场景，再测试复杂场景

#### 代码规范
1. **命名一致性**: 前后端使用相同的业务术语
2. **错误处理**: 统一的错误处理和提示机制
3. **注释文档**: 为复杂API添加详细注释
4. **版本控制**: 及时提交代码变更

### 📝 故障排查模板

当遇到前后端连接问题时，按以下顺序检查：

1. **确认后端服务状态**: 检查API是否正常启动
2. **验证API路由**: 使用curl直接测试API接口
3. **检查请求格式**: 确认HTTP方法、路径、参数正确
4. **查看错误日志**: 检查前后端详细错误信息
5. **重启服务**: 必要时重新启动后端服务
6. **清理缓存**: 清理浏览器缓存和前端构建缓存

### 🛠️ 调试命令

```bash
# 测试API接口
curl -X GET "http://localhost:5002/api/Controller/action" -H "Content-Type: application/json"

# 重启后端服务
# 1. 停止: Ctrl+C 或 KillBash
# 2. 启动: dotnet run

# 查看进程状态
netstat -ano | findstr :5002
tasklist | findstr dotnet

# 清理前端缓存
rm -rf node_modules/.cache
npm run dev
```

## 🚨 重要提醒

### 新功能开发必检清单
每次添加新的API接口或修改现有功能时，必须按顺序完成以下检查：

1. **🔄 重启后端服务** (最重要!)
   - 修改后端代码后，必须重新启动dotnet服务
   - 使用KillBash停止现有服务，然后重新运行`dotnet run`
   - 等待看到"Application started"日志

2. **🧪 API接口测试**
   - 使用curl命令直接测试新API
   - 确认返回正确的JSON格式响应
   - 验证错误情况下的响应格式

3. **🔍 路由匹配检查**
   - 前端API路径：`/SystemParameter/book-item/${bookNo}/${itemNo}`
   - 后端Controller路由：`[HttpGet("book-item/{bookNo}/{itemNo}")]`
   - 确保大小写和格式完全一致

4. **🔐 权限验证**
   - 确认新API是否需要`[AllowAnonymous]`注解
   - 检查JWT Token是否过期（默认3分钟）
   - 必要时重新登录获取新Token

5. **📋 参数验证**
   - 前后端参数名称和类型匹配
   - URL路径参数顺序正确
   - 特殊字符需要URL编码

### 故障快速诊断命令
```bash
# 1. 检查后端服务状态
netstat -ano | findstr :5002

# 2. 测试API路由
curl -X GET "http://localhost:5002/api/SystemParameter/book-item/test/1"

# 3. 检查后端日志
# 使用BashOutput查看详细错误信息

# 4. 重启后端（必要时）
# KillBash → dotnet run
```

### 常见错误代码速查
- **404**: API路由不匹配或后端未重启
- **401**: JWT Token过期或权限不足  
- **500**: 数据库连接错误或代码异常
- **CORS错误**: 跨域配置问题

### 开发优先级
1. **后端优先**: 先确保API接口正常工作
2. **curl测试**: 直接测试API，排除前端干扰
3. **前端集成**: API确认无误后再进行前端开发
4. **端到端测试**: 完整功能流程测试