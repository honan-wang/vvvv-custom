# 后端程序整改意见

## 1. 接口契约与字段命名规范
- 对照《问题过程.md》中记录的字段映射错误，建议在后端模型上显式标注`[JsonPropertyName]`或引入专门的请求DTO，确保前端字段与后端属性一一对应，减少400错误。
- 将统一的请求/响应结构整理成公开的API文档（可借助Swagger注释生成），并在`Scripts/`或`docs/`目录维护接口说明，防止前后端理解偏差。
- 在`ApiResponse`基础上补充错误码枚举及字段含义说明，保证异常场景也能输出一致的结构，支撑前端统一处理（参见《CLAUDE.md》的统一响应要求）。

## 2. 数据校验与防御式编程
- 结合《详细设计文档.md》中提到的业务规则，扩展`DataAnnotations`或自定义验证属性，覆盖车重、进出标志、账册号等必填校验，并在`ModelState`失败时返回可追踪的错误细节。
- 在保存核放单、车辆等场景中补充业务级校验（如重复提交、数据一致性检查），并通过单元测试锁定校验逻辑。
- 对请求体进行空值和类型校验，避免因字段缺失导致的`NullReferenceException`或数据库异常。

## 3. 安全与权限恢复
- 根据《process.md》的临时调整记录，尽快恢复`Program.cs`中的`UseAuthentication/UseAuthorization`管线以及各控制器上的`[Authorize]`特性，防止测试配置误留到生产。
- 在`backend/CustomsDeclaration.API`内新增环境配置开关，使开发环境可以通过`appsettings.Development.json`显式关闭认证，而生产默认开启，避免手工注释代码。
- 定期审查`JwtSettings`过期时间和密钥管理，结合日志记录登录/操作行为（参考`backend/README.md`安全章节）。

## 4. 数据访问与事务可靠性
- 按《详细设计文档.md》中事务管理优化方案，统一使用`DbConnection`/`DbTransaction`异步接口，避免`IDbTransaction`在高并发下的潜在阻塞问题。
- 在`DatabaseHelper`中增加超时、重试与异常分级记录，出现数据库错误时能够快速定位并保持幂等。
- 针对双库支持，抽象SQL生成逻辑放入独立策略类，集中维护SQL Server、Oracle语法差异，减少散落在各服务中的条件判断。

## 5. 性能与缓存策略
- 落实《详细设计文档.md》提出的缓存需求，对下拉选项（港口、区域、料件性质等）使用内存缓存或分布式缓存，降低频繁查询负载。
- 评估批量保存、批量查询的场景，将商品明细写入操作改造为批处理，减少多次往返数据库的开销。
- 在高访问接口上补齐性能指标收集（响应时间、吞吐量），并配置Serilog写入结构化日志以便后续分析。

## 6. 日志与监控
- 扩展`GlobalExceptionMiddleware`的日志内容，记录请求路径、调用链标识和关键参数，配合《问题过程.md》调试经验改进排障效率。
- 在核心服务（如`DeclarationService`、`UserService`）中添加业务级Info日志，辅助追踪操作流程，并将异常栈区分`Error`与`Warning`级别。
- 建立日志轮转与保留策略，确保`logs/`目录文件可控并易于归档。

## 7. 配置与环境管理
- 将`appsettings.json`中的连接字符串、JWT密钥拆分至`appsettings.{Environment}.json`或安全存储，并遵循《AGENTS.md》中的安全建议，不在仓库中保留真实敏感信息。
- 引入配置校验启动检查（例如`OptionsBuilder.Validate`），在应用启动阶段即发现缺失或错误的配置项。
- 为多环境（开发/测试/生产）准备标准化的部署脚本或文档，确保数据库脚本、日志目录等按《backend/README.md》约定放置。

## 8. 测试与质量保证
- 按《AGENTS.md》测试指南，补充`backend/CustomsDeclaration.Tests`项目，覆盖服务层、数据层关键逻辑，特别是字段映射、事务操作、权限控制等高风险点。
- 编写集成测试验证`ApiResponse`统一性、认证流程和多数据库切换行为，避免回归问题。
- 建立故障排查模板中提到的检查脚本（curl、自检端点）为自动化测试准备，持续集成中执行。

## 9. 文档与流程
- 将《CLAUDE.md》《process.md》等经验整合为后端开发手册，明确接口变更流程、调试基线和常见问题排查步骤。
- 每次修改接口后更新Markdown说明，并在PR模板中要求填写影响范围、测试结果与日志位置，保持信息同步。
- 对关键业务流程（核放单保存、车辆管理、用户管理）制作时序图或流程图，降低新成员理解成本。

以上整改项请结合实际优先级排期落地，确保后端服务在安全性、可靠性和可维护性方面满足上线要求。
